---
apiVersion: v1
kind: Namespace
metadata:
  name: twistlock
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: twistlock-view
rules:
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]  # Allow Defenders to list RBAC resources
    verbs: ["list"]
  - apiGroups: ["apps"]
    resources: ["deployments", "replicasets"]  # Allow Defenders to get Deployments and ReplicaSets
    verbs: ["get"]
  - apiGroups: [""]  # Core API
    resources: ["namespaces", "pods"]  # Allow Defenders to get Namespaces and Pods
    verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: twistlock-view-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: twistlock-view
subjects:
  - kind: ServiceAccount
    name: twistlock-service
    namespace: twistlock
---
apiVersion: v1
kind: Secret
metadata:
  name: twistlock-secrets
  namespace: twistlock
type: Opaque
data:
  service-parameter: ZDUwaTk4TXpCQVVFZ1dCRzR2Mklma241U01vQW5zM3VPY3Yyek5vZUt5UGFUSEtSWWZuUndXWFNNM3VvT3VwZmNoYS9Ob1pabThLMWlGWEh1cCtUZWc9PQ==
  defender-ca.pem: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURIVENDQWdXZ0F3SUJBZ0lSQU9Pb1VyS0lVT1pyczk1c1FmeXBpNmt3RFFZSktvWklodmNOQVFFTEJRQXcKS0RFU01CQUdBMVVFQ2hNSlZIZHBjM1JzYjJOck1SSXdFQVlEVlFRREV3bFVkMmx6ZEd4dlkyc3dIaGNOTWpNdwpNVEkzTVRRek1EQXdXaGNOTWpZd01USTJNVFF6TURBd1dqQW9NUkl3RUFZRFZRUUtFd2xVZDJsemRHeHZZMnN4CkVqQVFCZ05WQkFNVENWUjNhWE4wYkc5amF6Q0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0MKZ2dFQkFMYWdVNmp6eVh2cUVuWFVsQ2I4OXdLODQzSVhNWXhQaFp6Wk82eklLaUU0a2pRVzhWeUZLMXZJelVwagpUYUpFM3R1SUFHbHpOcUJDRFR6SS9ENDRtcVlvWWlTbUhXdllOSVhJSGNsUGI2NE5DS242dStFRUcxd211NTdLClBDVld2SHdmbFdvOFVmcktMVmZSZ3ZQcHlFdFhPdEhLQ1BaRXAyWm9HcWhWeks5Y2F1TnZTU0hzbTZPVTFrb3YKR2R0Ny80TGJsZDkrKzRaOUdBR0d0aTFSQURtRUN6K21qK1lsekVNUVdkSTNNS3ZBWDdSQzRtL0w5aDQ2SXZvagpRVWxGYzdLMkVkWk5SREI0eEFDM1Rucm9NZGlxMzdlZ05HK3VKamJKSCt5cXluT0tYdWk4TkNTRDZ4N3VGY2d2CnZDVmJpV2tmUkpmRmNCeGp5YkZVUnNjWlcvOENBd0VBQWFOQ01FQXdEZ1lEVlIwUEFRSC9CQVFEQWdLc01BOEcKQTFVZEV3RUIvd1FGTUFNQkFmOHdIUVlEVlIwT0JCWUVGRUg5dWVXdHpady9XUC9WTlg0L2tTNFRPejJ3TUEwRwpDU3FHU0liM0RRRUJDd1VBQTRJQkFRQmZMb0NhN1Y1cGlkTnpvRDVZUFY5VWxlb1dpOFRhS25GTzZhMzgycnY1CkV6aUdZOUlXT2lYNmowYndWMHJ6UUE2QjNnS2paTVIxRFdwUDJtUjMxZFRtM3FCYUxLQlRGaC91QVhtWERnVnUKOFdQN09FaFR2Mjg0TTlleVJQRlBRMmtRUHRONmtNYWpqZEo1MThjNGU3QW9acDhIRnlvNzBUc3hKS29XNjJVVApMaTJMZm9qQnpFN0Rad2tYYnF0Q2pQWWpYQlBkY2xZZW01c0llbWkzR0U2VmxOTDhlRDFNQUxlMk5DVHJ1eTBmClo5VElTWTFKeEQvVkpDNzhMV0J1QWNXeE5XaHp5Tlk4bDdJcFlEd2JsOTBmT21uSG1GR1RkL2cvbWtSbGZPeWoKOUw1ZEg5U1Q2eEZIVHlwUTBLYlBjZ1M3ZlNERTh3OWt1eWN1dFZrWngzRmcKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  defender-client-cert.pem: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURPekNDQWlPZ0F3SUJBZ0lRZVpQZFc1UFFTUHhhTDRvbk9ydlRMakFOQmdrcWhraUc5dzBCQVFzRkFEQW8KTVJJd0VBWURWUVFLRXdsVWQybHpkR3h2WTJzeEVqQVFCZ05WQkFNVENWUjNhWE4wYkc5amF6QWVGdzB5TlRBNApNVEF4TURNNE1EQmFGdzB5T0RBNE1Ea3hNRE00TURCYU1DZ3hFakFRQmdOVkJBb1RDVlIzYVhOMGJHOWphekVTCk1CQUdBMVVFQXhNSmJHOWpZV3hvYjNOME1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0MKQVFFQXl6bVZNek9lQ1hSd0RLM2pickJ1a002WWFOWmVGZy9QeUh2ZjFMSVdNNFIxakhHZFZWbmEvbUtmSjcyMgpwNFNLRy9LbmIxQzJkeU9tVkE3OExMWEY1NmJzZFlONjQwdHhDOTNzSmY4MHoxNkI5Qmp1OEVBRjRaZWpFcFlZClp2Q1lMU0JrYklNUjRBb2JTTkFicmV5WnUvZjdpV0pXTWQrY0IxdnVJWmY5SU1xUGVuVFdzYk5ETzIyczd2d2oKVmE1VVRTaFRjOUdiaTB6MXIyMTFKUU1yaHhKYVdPdm85c0RsWkxFSnJVazlKYmM1OWZoTFhCN01sOW9uY3dJVwpRRjhVaWtPNUd6eGdYRk9uUkpYS09mcWxyc3VJSUtjRnQwMVl5OGpkc3ZNOWdBUlBhOVZybEQ3VXE4N29HMFBUCkdEV2xuNnJDcVk0cDVXOXRKMUgvcVU3Mkl3SURBUUFCbzJFd1h6QU9CZ05WSFE4QkFmOEVCQU1DQjRBd0V3WUQKVlIwbEJBd3dDZ1lJS3dZQkJRVUhBd0l3REFZRFZSMFRBUUgvQkFJd0FEQWZCZ05WSFNNRUdEQVdnQlJCL2JubApyYzJjUDFqLzFUVitQNUV1RXpzOXNEQUpCZ1VxQkFFQ0J3UUFNQTBHQ1NxR1NJYjNEUUVCQ3dVQUE0SUJBUUNNCnl1dzVYYm1OSTZ0L2RtR1lFUWl6TlFIek9kN3hTZGpIMjBFdkpuM2FiMXZ0NXU5Ry9xSjZSMHA2UDF3QzFqMWEKTE9ORFZBeVJxVGxZS3lmU0d1UVJUWjMyNlJ3cDdvbkgxcHNsSS9nc2ZOcEcwbzF0WDBVcys5eGFZSHRLeWFiYgpIL0JzNXVvMFhTSWJscnFCeUtXRnpEQ2ZsUHJwaGNjQ2N1d1hScjBYRUNoUVFzNVFmUEI3ODAvUWRPUFhUbklNClZkL3pLUFFKNXZrbG54b3p5eDRaV1FJWm4zeHdxbEp5UGJKZXlTZkRFTGNOVmF0SExzUy9iaHZmNzJ6UkRoYWwKZmJPbFZwQ3cxaTNGTlltdlJwOUpnZVNDcWpWTFBIdUdZQmthTmZkSTJMSXhtY2s2VVBvNm45cUFFYXpCU0xMQgp0Y3pySGl0U2pzSnoxZTRPWkNZRwotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  defender-client-key.pem: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpQcm9jLVR5cGU6IDQsRU5DUllQVEVECkRFSy1JbmZvOiBBRVMtMjU2LUNCQyxiMDRhMzMyOTY0YmI0NGQ4ODk4ODNmZjZmMmJjNDM4MgoKVVoyUGM5a0oyREJ6enBNZzdTbFpQemMxS2ErRk5xMFVORWRVcHdLbm1WMk5Bd3RYUE1EUmNKNEJ5WUNKQkwwYQpVTVowa1A2Rkk4RGlBeHlMK2NGVTM2OVhSZmpzeFUzZnZvMWI4eE1ETVJOMk82aHpZY2dlbTdCN1J2RmdJdy9WCm5oanIvQ2p1bkNqUXdNaDVIOHFtYVh6ZGxrOFgzc1cybmx6U01NTFJoNGxQSnExcGFSNUZLY1ZEUC8rY3ZURUMKUjZTVXJBS0p0am5USjI1VTFERTRMK2poUXZSTEVLTG40bDJ6TU5veVl0TE10MVNNM2NMZ1k3cG9ydU5ZNXhsQwo3MC9mcW9UNjQyU2xWdDE4SWk2ZmpPdENPRlZWV1RmSU1pcDhVY1lPRmV0djF2RGE4NHVGZW1OaFpXVVUvMkdXClJEVkNuVEZIZFE2QWtsY1VNWlByd01HNUZHbHdnazRicUorMHpnUnA5bk55OCtKMk13MHdQZGNMYUNzbDhGVEYKdGZ3VjlLNHprWjZaZzJwUEZ0bzBreEw5QzIxZTRpYUNkS3lVbUZFVWdWTlBkRFFJZ3cwSUNhc0ZjczRxeThRTApsSkovRXpSRkQ4L2RxekdLSlpGY1d1aE9QV3NuSDM4R2hiNlFqRWVJTDkrZFgrVTIvKzZLSU9VL3lrRlBUTzJ5CnFSSnpORGJiTm5HTXRDQXlrMVQyZXNTRHZtRHowSFRwMmtoR3hhUndBSzJHSk9ueXN3cThibVkvQW1STVpuNWYKTHNOVUFKTkpoellGQUs1VnEvNlBucDJoVWtOVndwTy9CTU4wT3c4NkZRVFRUTkw4bER1R3dseUtEbDF3WTVUYQpHbXVJZjgwVzBYdjhjSmhZYjI2REFwbnFDS0NOT3JGb0xaZ3dDNEFvNWFyb003b0UyZ2V5YmwrS3QzMWRLQkJRCmtaQlUxU1pZdGV0M1liRi8xMThiZ3lFbXJWZ29RTVpEeGd5Tm81dTlKWEs1ODBJWGVlLzdvajJkZTZQb0hERUsKS0FYWnhiZExtWVVyamR1YWtvdWw4YXo3eUJtNHpkME05eFVUME5aenBpTjZpMTRpZUlxYjJzSWZDVWQ4U204cApKVTFKV05qNjZjcHNmTHNqbkNtaVNWcEkwTFBqUmhndEsvb3Jab2NpTWt1L1VoU1hSNmdzWnUxMGYvcE1XODlHCmZZLzVTcklQSDlLSWVWRkd2Um5SK2pKQ0xaNm1uQXlpc0F1Z09zaE1DTTJJZCszeDc1Nng1dTJjSllnekwwZkUKbUhGODliRWpXQTZycXZmQTBEQ2drT1oxa2lhR1pDWXVTa1BObnF2ekRkSUJieGhPV3VSY3FKTURLdWxCemZDWApIdDJWUUlOOVRWRXUzZUVlN2NFbi9IOVJ2Qjd2enlKUi9YYytVT0kxajhCTy8rL1lMZ3JXbHlJUVVhbDd2SmdmCjVFQmMybzlnUGVZZlhzcHF4Z2ZpYi90VFcxYStQdERjY1NvaCtaL0JDcStQVlNUR3N5WWMrWkhMSFNROXZrUkIKdVNKeE9XaDNLaDJ6N3hzRHVGOUhRZ21SY0VFZTNMY0I3a01QTDQ4TWVKbTNVZWRJb3JiZC8yQTBBL0ZwdWkrNApVbzNpT3owcURNcHNDYnpIdE8reWZqbWZ3WHFmdnZpSG1sSmdvVHd2dEhaYXZtUXRiNzRIK0JpOWZXZzV5MWpqCkxZdlhxOTRPbUorQ0lWeE54VXd2WEY1WTBwMTFTanRzZGtHbmtqeXlJUy9BT2gvUm9hY2NsL20xRnAvWGRtNVIKb1FpbWp6NVFYallvM1dad0cyeSt3WjA3R3VhcVFTTEtrSzZKb3JmMWdDeUI4amd5cVkvYkYxTkU5MGYvYlVxcAo3dXFMbTRoRTVCR2NKNDJlMFhzN3FkMGJ6aUpTMWorbExlUE9wTE1BQzUvUHBZdnh2YWhRYWUwSGFvOEdaR09GCjZnOVJBOWoxdmUrVjBPSWIvVFpmUXQwUjA1VXVLMUJoK2FmTnlsUFRFMDJSWm9ndnFLR0VBaHZXSzIrVUwzQWEKZUxqNUxqZHcvZFgzWlRaUVJ5ZVBPam8vUUZlNktGa2d5ZCtNQXU3WFRCeDdLdWFwUXlNYlJ5RGFmWkh1THBJVgotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
  admission-cert.pem: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURURENDQWpTZ0F3SUJBZ0lSQUtiRFN1Zk1RdkJ4QVoxZldpamRoSkF3RFFZSktvWklodmNOQVFFTEJRQXcKS0RFU01CQUdBMVVFQ2hNSlZIZHBjM1JzYjJOck1SSXdFQVlEVlFRREV3bFVkMmx6ZEd4dlkyc3dIaGNOTWpVdwpPVEF4TVRjMU9EQXdXaGNOTWpnd09ETXhNVGMxT0RBd1dqQVVNUkl3RUFZRFZRUUtFd2xVZDJsemRHeHZZMnN3CmdnRWlNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUUMrZzJuOVVGamdXY2piaElDQlZNcVUKeXlKM1Z0QVUwaXIrbzhIRWloZEJ2eHZLYXFxS2I4MTl3TEtGbEc0ZkU0dVdnYVhhbHlzUHlHNVdmL0hmTlpnKwo2SlR3cUkxNlcvbXNLSm5yb3NqSXhtcGJibnYvTlpBemhxTFRyeHpnV2FTZmhodFhhdU5Kam5uTDl5dHg4ZUhPCjhCbkNKUnVSNG1rTzV4WnRad28zSzFEZzJ3S1Z1V1pLVCtFVUc1d3k1eU5CcVg4WFNsaFdQUXZJaVVHQzRCSVkKZ25tTUcza3owa0JsNDVKUFQzWCtSbVhHamoyajlyUFBpQVF4NGhtZEFNQ3p3c2tPcXZhZTh3VDFHWlIxeXl6TQoybG1XNUg4WHVVVk5DdU9kSnhHS2Z5d1dYSlJGVWtNb2xJa1lyNVN4eEZJWlk0UHkzSGNOYjZ3ZWRrQ1RVQlZoCkFnTUJBQUdqZ1lRd2dZRXdEZ1lEVlIwUEFRSC9CQVFEQWdPb01CMEdBMVVkSlFRV01CUUdDQ3NHQVFVRkJ3TUMKQmdnckJnRUZCUWNEQVRBTUJnTlZIUk1CQWY4RUFqQUFNQjhHQTFVZEl3UVlNQmFBRkVIOXVlV3R6WncvV1AvVgpOWDQva1M0VE96MndNQ0VHQTFVZEVRUWFNQmlDRm1SbFptVnVaR1Z5TG5SM2FYTjBiRzlqYXk1emRtTXdEUVlKCktvWklodmNOQVFFTEJRQURnZ0VCQUVvcGxEN2hUcnFUL1E5RkRheHViNXk0Mmg1WVIzVHp6Q0xjdnpkblp4VU4KVnhGb0twZTlFdEQ1R25hd04vRkNkVm1QNVRnTG1yT3NJT21EUWt5d2FzVUlOdDlicTJ3eUVjQnhETG5Vd291RApFZXQ0Mi9UZFZyN2dIOHJqbGlRZ0xUUjBXNG1pb1BlTHJIRlpMSGFXWlRWUE0wY1IzWWNJcE1XbGlGRTRocUtMCjl2bjViV2RsVE0wSmcva0Ruc25JZDRtZmFmbmk4WldiV1AvUjlETnFNTVNCMmxMUVRkY0J3enNueVdsemhwVmoKVzNQZDYvYjJEYmNvdGhyNEFJNFF4bTFVQm00SjQ0ODcxbFZ0cWtGaENGMFJORE9nUm5vQmtGTE9GRzBZdmpBeApsSUhOMVJEU2l6SGtxTGh2WTl4a1ZWYjRNTnRmcHhvVmhxZU1HRFFQc1pRPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  admission-key.pem: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpQcm9jLVR5cGU6IDQsRU5DUllQVEVECkRFSy1JbmZvOiBBRVMtMjU2LUNCQyw0YWYxOWVkZDFiMDgwMWU3YWEwZWViYmU3OGRjMTNmOAoKcVg3Nm9VeDN0NlI5dmJPbEFWdm9abmtLL2ZWa09KeXhrRHY3UnhpYlEzUjNVL0VpZkFzNkY0OTUyUEpMdUEzLwpGYkowdFJJVzRSMmdNcldHUkJZRjhVU2ZwQ0VEayswRk83V0diVnlhZFN4SVhqL05kUFB5S3NlRzVmQ05vTnZUCkk0L1hSY2pMK3ZHVVRLc3BPZ2t2SEJDTVlkMU1rRDhyS2xxNlVNMDM3OEYyZ0NFbms3Ri9LRnNEVnlhdllWdksKeEl4Q2pPZUFYdkd3RCs1Mmo4Vk92bUFWY25TWFlmSCtJQTg3TDBLOFgyeG5nUXdZK3JRWE85TGZWNCtqNEwvZApaNDV4UDRMS3FhN21jcTVYbWs3b1BVQzF3VDlJYnFtbmFlc3o2eHJnTE9CRzJ3WlNVNjRBY0g1ZEZCV1VMTFMwCldMUHZPYVBBNFRuZ0YwWGIrRmRVTSs1cDBBYzMxZk5BSy8zbFFqQzdHZTcrdnM0MFprN0E2MTU1Z3YyUGFTYVQKTGRlODZiQlpHS0dKRUZERVlrQS9UOXdrOGtJSW9HN1F4Q0JhNSsvVzVSTlRBYmlkcXp3T1VhNis1RDM3akhDQQpNS3g4b1JTbVFTTjVYRTVoTWkrLzg4ZWlSS09qVmg5d014VVdRNXpYcHRQWFdQYVBEL092SnhzOWJoOE5MaVcxCm04WTBVNzZwTFExUnZnTUNqcy9PLzlnZWdxbkl1V09HUkVnLzlPMlVtMnlLWWpvUllKQXhGQ0dkNWx0dWFiZW8KMk0zMmFhY1hKcW9IdUFPVlZjanlWYzZNbU1qUjVrYXprYkNxY3NoWW92ajNoTEhyK2cxRVl4bUcxVVpFaERuWAowcnpJYzdQMjBnWTUyMnM3Y2gxNmFtQWdKZDNXUUw4K3VoNUlhVkdyY3NEcW5BazVPVUhiSVoyaHNPT3VlRWtMCi90RVpoU0Q4SGFFQWdHeVJORTNxZW9yVFVrcWpEZVcrVXlIdCtod056eDlrdjJ6ZGZ5VUZ2ays1YXBVMUZKZkgKbDdjbnhSUWgyZXNKYVZsZVJPRTM3Z0IrYkRvV2ZZQ24vT0ZmUFN0c1cyMG15UHlKUCsrdFcwVXcvejQ3UXBhUgprYzc0ZG5RczF6K0FQMVZMYTVIT3Q5eUdHY1VQTEk4WXQ1L0FUQmUwT2w3VjJidHBmYVZXNE4wU1FMUVhWRGdaCkwvaXZGTjdmcnJxWXhmQkxxdWdVZzVId25Ic1lyWVU3anZ3U2gzVUNycFFVbzE1MU1aUWU3alY0ZXYzNllGYjAKVWZva0hzOHhKWUl0UmFrc2NCL2dwUHlTMnUvRVRNakoxTkczUkpEZkZVTit3cEFseEUzL0xxbksrTFU3SXhsUQpCa29FcUxUTkxHZDNHa01Pc0RhNnQybllCVFc1MkE0RHpZczk2bEl3dkhsYnJ2bzFBM0VMVmczdDBGKzdqVTVPCkFaOCtiRlVZc01rQUd5YXFhMHVqSmZXRjRUQ1VTa05wOGd1TG9GVHV6YUtHY25QQU5aTTZJZFVrVjEwc01ETjkKclJrR2VaSnBIVVZTUzRtUVhURVEyNDhqZk9PQS84alY1S3hTR0ZjYUFBWE1tQnJKdllabGpUMHhaa2xJUWwyTgpQMk1xMlVseDV4Z3AxWmtRYmVUdnB3RjRJZnZ2R3cvS3czZzFrQVF1M1dqaGZEbmo0ZUkwOXN4Z0IrSFpON3h5CllNQTVZMzQ5NEw2bVZvZURjR1JSOXRFMXFISEczNEJFL1ZtVmpRVDdUb3FqenRQVTl5MnZVTklDR0RnK01KSFkKOHVaa2FUc3lvTlZzUHlIdEM1bkZHWWtERS80OWE3SUg0eU5ZRXdKQ1ppek83OXdWOEZtUnpxakZUUW1uUFJabwpBakJFdzdyRTMzYkY1QnJ5WXhLL21lQUdwTGErRFRYQzhXUkMzeDV1cytzU015NStsV1dmbzdPVEI2NmF0ZzhjCllFdkovVXg0NW9vVk5nSmd0V2s3VVUzUDlkK1Q1bzh1QVk4dVRYeXU1aWViQ3NDbkVBRTZWazNhNWlGUzVwYncKa2krbE9aV0wvTW9lYXFlQ0pVTG5aQ2orTHFjN1RzeXY4UmVXR3FVZFdMd3ZQbUtBaXVLOEtQb2VFdUIyZWNWeAotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=

---
apiVersion: v1
kind: ServiceAccount  # Service Account is used for managing security context constraints policies in Openshift (SCC)
metadata:
  name: twistlock-service
  namespace: twistlock
secrets:
  - name: twistlock-secrets
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: twistlock-defender-ds
  namespace: twistlock
spec:
  selector:
    matchLabels:
      app: twistlock-defender
  template:
    metadata:
      annotations:
        container.apparmor.security.beta.kubernetes.io/twistlock-defender: unconfined
      labels:
        app: twistlock-defender
    spec:
      serviceAccountName: twistlock-service
      restartPolicy: Always
      containers:
        - name: twistlock-defender
          image: registry-auth.twistlock.com/tw_0uchx1fydjtjdemwtvgh538up3q5t1qq/twistlock/defender:defender_34_02_133
          volumeMounts:
            - name: data-folder
              mountPath: "/var/lib/twistlock"
            - name: certificates  # Setting the certificates mount after data-folder since it is nested and was overridden in CRI based GKE cluster
              mountPath: "/var/lib/twistlock/certificates"
            - name: docker-sock-folder
              mountPath: "/var/run"
            - name: passwd
              mountPath: "/etc/passwd"
              readOnly: true
            - name: syslog-socket
              mountPath: "/dev/log"
            - name: cri-data
              mountPath: /var/lib/containerd
            - name: cri-rke2-data
              mountPath: /var/lib/rancher/rke2/agent/containerd
            - name: runc-proxy-sock-folder
              mountPath: "/run"
          env:
            - name: WS_ADDRESS
              value: wss://us-west1.cloud.twistlock.com:443
            - name: DEFENDER_TYPE
              value: cri
            - name: LOG_PROD
              value: "true"
            - name: SYSTEMD_ENABLED
              value: "false"
            - name: DOCKER_CLIENT_ADDRESS
              value: "/var/run/docker.sock"
            - name: DEFENDER_CLUSTER_ID
              value: "6179b9dd-f72a-7c11-9384-87e75f50dc62"
            - name: DEFENDER_CLUSTER_NAME_RESOLVING_METHOD
              value: "default"
            - name: DEFENDER_CLUSTER
              value: ""
            - name: MONITOR_SERVICE_ACCOUNTS
              value: "true"
            - name: MONITOR_ISTIO
              value: "false"
            - name: COLLECT_POD_LABELS
              value: "true"
            - name: INSTALL_BUNDLE
              value: "eyJzZWNyZXRzIjp7fSwiZ2xvYmFsUHJveHlPcHQiOnsiaHR0cFByb3h5IjoiIiwibm9Qcm94eSI6IiIsImNhIjoiIiwidXNlciI6IiIsInBhc3N3b3JkIjp7ImVuY3J5cHRlZCI6IiJ9fSwiY3VzdG9tZXJJRCI6InVzLTQtMTYxMDU1NTAxIiwiYXBpS2V5IjoiRk03d1NsL2ZKc0laL3R5L0RKVWVLeHB6RE1JZmVsakVUQnlsLy9zemJOYThqeXBaeE5WWXZqd1RTcjQzczlFelNCVjBianQ1WmJpMm1lSG5sVERrd2c9PSIsIm1pY3Jvc2VnQ29tcGF0aWJsZSI6ZmFsc2V9"
            - name: HOST_CUSTOM_COMPLIANCE_ENABLED
              value: "true"
            - name: CLOUD_HOSTNAME_ENABLED
              value: "false"
            - name: FIPS_ENABLED
              value: "false"
          securityContext:
            readOnlyRootFilesystem: true
            privileged: false
            capabilities:
              add:
                - NET_ADMIN  # Required for process monitoring
                - NET_RAW  # Required for iptables (CNNF, runtime DNS, WAAS). See: https://bugzilla.redhat.com/show_bug.cgi?id=1895032
                - SYS_ADMIN  # Required for filesystem monitoring
                - SYS_PTRACE  # Required for local audit monitoring
                - SYS_CHROOT  # Required for changing mount namespace using setns
                - MKNOD  # A capability to create special files using mknod(2), used by docker-less registry scanning
                - SETFCAP  # A capability to set file capabilities, used by docker-less registry scanning
                - IPC_LOCK  # Required for perf events monitoring, allowing to ignore memory lock limits
          resources:  # See: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/#how-pods-with-resource-requests-are-scheduled
            limits:
              memory: "512Mi"
              cpu: "900m"
            requests:
              cpu: "256m"
      volumes:
        - name: certificates
          secret:
            secretName: twistlock-secrets
            defaultMode: 256
        - name: syslog-socket
          hostPath:
            path: "/dev/log"
        - name: data-folder
          hostPath:
            path: "/var/lib/twistlock"
        - name: passwd
          hostPath:
            path: "/etc/passwd"
        - name: docker-sock-folder
          hostPath:
            path: "/var/run"
        - name: cri-data
          hostPath:
            path: /var/lib/containerd
        - name: cri-rke2-data
          hostPath:
            path: /var/lib/rancher/rke2/agent/containerd
        - name: runc-proxy-sock-folder
          hostPath:
            path: "/run"
      hostPID: true
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
---
apiVersion: v1
kind: Service  # Expose the Defender as admission controller. Remark: by default, Defender will not listen on the service port
metadata:
  name: defender
  namespace: twistlock
  labels:
    app: twistlock-defender
spec:
  ports:
    - port: 443
      targetPort: 9998
  selector:
    app: twistlock-defender
